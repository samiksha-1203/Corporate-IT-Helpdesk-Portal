<!DOCTYPE html>
{% extends "base.html" %}
{% load static %}
{% block title %}Support Engineer Dashboard{% endblock %}
{% block content %}
{% load custom_filters %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Engineer Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4682B4;
            --primary-light: #E3EAF3;
            --primary-dark: #3A5683;
            --secondary: #6C757D;
            --success: #4CAF50;
            --success-light: #D4EDDA;
            --warning: #FFCF54;
            --warning-light: #FFF3CD;
            --info: #4DA3FF;
            --info-light: #CCE5FF;
            --light: #F8F9FA;
            --dark: #212529;
            --gray: #A4B0BE;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --ticket-red: #E74C3C;
            --ticket-red-dark: #C0392B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F5F7FA;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 20px;
        }

        header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .welcome-message {
            width: 100%;
            margin-bottom: 15px;
        }

        .welcome-message h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
            flex-wrap: wrap;
        }

        .welcome-message h1 .user-badge {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
        }

        .welcome-message p {
            color: var(--gray);
            font-size: 16px;
        }

        .search-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .search-filter-row {
            display: flex;
            width: 100%;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .search-bar {
            display: flex;
            flex: 1;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            background-color: white;
        }

        .search-bar input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.2);
        }

        .search-bar button {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .search-bar button:hover {
            background: var(--primary-dark);
        }

        .filter-container {
            display: flex;
            gap: 10px;
            min-width: 300px;
        }

        .filter-container select {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
            background-color: white;
            min-width: 120px;
        }

        .filter-container select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.2);
            outline: none;
        }

        /* Color-coded status dropdown */
        .status-select {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 8px 10px;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .status-select.pending { background: #f0f4ff; border-color: #7f9cf5; }
        .status-select.in-progress { background: #fff8e1; border-color: #ffcf54; }
        .status-select.resolved { background: #e7f6ea; border-color: #4caf50; }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: none;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-card.active {
            box-shadow: 0 0 0 2px var(--primary);
        }

        .all-tickets {
            background-color: var(--primary-light);
        }
        .all-tickets::before {
            background: var(--primary);
        }

        .pending-tickets {
            background-color: var(--warning-light);
        }
        .pending-tickets::before {
            background: var(--warning);
        }

        .in-progress-tickets {
            background-color: var(--info-light);
        }
        .in-progress-tickets::before {
            background: var(--info);
        }

        .resolved-tickets {
            background-color: var(--success-light);
        }
        .resolved-tickets::before {
            background: var(--success);
        }

        .stat-info h3 {
            font-size: 16px;
            color: var(--dark);
            margin-bottom: 10px;
            font-weight: 600;
            position: relative;
            display: inline-block;
        }

        .stat-info h3::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: var(--primary);
            border-radius: 3px;
        }

        .stat-info p {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            margin-top: 10px;
        }

        .tickets-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
            width: 100%;
            transition: all 0.3s;
            opacity: 0;
            transform: translateY(20px);
        }

        /* SLA Alerts styles */
        .alerts-list { display: flex; flex-direction: column; gap: 10px; }
        .sla-alert-item { display: flex; align-items: center; gap: 16px; padding: 12px 14px; border-radius: 10px; text-decoration: none; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); color: inherit; }
        .sla-alert-item .icon { width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; border-radius: 8px; background: #f1f5f9; color:#6b7280; }
        .sla-alert-item.critical .icon { background:#FEF3F2; color:#DC2626; }
        .sla-alert-item .content .title { font-weight:600; }
        .sla-alert-item .content .desc { font-size: 13px; color:#6b7280; }
        .sla-alert-item .cta { margin-left:auto; color:#7C3AED; font-weight:600; }

        .tickets-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .tickets-container .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tickets-container .card-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .tickets-container .card-header i {
            font-size: 24px;
            color: var(--primary);
            background-color: var(--primary-light);
            padding: 10px;
            border-radius: 50%;
        }

        .ticket-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }

        .ticket-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ticket-table th {
            background-color: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid var(--primary);
        }

        .ticket-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            color: #333;
            vertical-align: top;
            transition: all 0.3s;
        }

        .ticket-table tr:last-child td {
            border-bottom: none;
        }

        .ticket-table tr:hover td {
            background-color: rgba(70, 130, 180, 0.05);
        }

        .ticket-table tr.active {
            background-color: rgba(70, 130, 180, 0.1);
        }

        .ticket-table tr.active td {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            min-width: 90px;
            text-align: center;
            transition: all 0.3s;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        .status-pending {
            background-color: var(--warning-light);
            color: #B78A00;
        }

        .status-in-progress {
            background-color: var(--info-light);
            color: #000;
        }

        .status-resolved {
            background-color: var(--success-light);
            color: var(--success);
        }
        .attachment-thumb { display:inline-block; width:72px; height:56px; border-radius:6px; object-fit:cover; background:#fafafa; border:1px solid #e5e7eb; cursor: zoom-in; }
        .select-colored { color:#111; }
        .select-red { background:#ffe0e6; color:#b00020; }
        .select-amber { background:#fff4d6; color:#8a5a00; }
        .select-green { background:#e8f8e8; color:#2e7d32; }
        .select-blue { background:#e6f0ff; color:#1e40af; }

        /* SLA remaining badge */
        .sla-badge { display:inline-block; padding:4px 8px; border-radius:12px; font-size:12px; font-weight:600; }
        .sla-badge.overdue { background:#FEF3F2; color:#DC2626; }
        .sla-badge.due_today { background:#FFF3CD; color:#B78A00; }
        .sla-badge.future { background:#E3EAF3; color:#3A5683; }

        .priority-high {
            color: #C62828;
            font-weight: 600;
        }
        
        .priority-medium {
            color: #FF8F00;
            font-weight: 600;
        }
        
        .priority-low {
            color: #2E7D32;
            font-weight: 600;
        }

        .action-btn {
            padding: 6px 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-right: 5px;
        }
        
        .action-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .action-btn.resolve {
            background-color: var(--success);
        }
        
        .action-btn.resolve:hover {
            background-color: #3d8b40;
        }
        
        .action-btn.comment {
            background-color: var(--info);
        }
        
        .action-btn.comment:hover {
            background-color: #3a7ab9;
        }
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            background-color: var(--primary);
            color: white;
        }

        .action-btn:hover {
            background-color: var(--primary-dark);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 15px;
        }

        .empty-state p {
            font-size: 16px;
        }

        /* Status Update Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            width: 100%;
            max-width: 500px;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            padding-bottom: 15px;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, var(--primary), #eee, #eee);
        }

        .modal-header h2 {
            color: var(--primary);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-header h2 i {
            font-size: 20px;
        }

        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.3s;
        }

        .close-btn:hover {
            color: var(--dark);
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s;
        }

        .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.2);
            outline: none;
        }

        .submit-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            width: 100%;
            font-weight: 500;
            margin-top: 10px;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(70, 130, 180, 0.3);
        }

        /* Update animation */
        @keyframes highlightUpdate {
            0% { background-color: rgba(70, 130, 180, 0.1); }
            100% { background-color: transparent; }
        }

        .updated-row {
            animation: highlightUpdate 2s;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .search-filter-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-bar {
                width: 100%;
            }
            
            .filter-container {
                width: 100%;
                min-width: auto;
            }
        }

        @media (max-width: 768px) {
            .welcome-message h1 {
                font-size: 24px;
            }
            
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .modal-content {
                padding: 20px;
            }

            .ticket-table th, 
            .ticket-table td {
                padding: 8px 10px;
                font-size: 14px;
            }

            .search-bar {
                flex-direction: column;
            }

            .search-bar button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .welcome-message h1 {
                font-size: 22px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .search-bar button {
                padding: 12px 15px;
            }
            
            .search-bar button span {
                display: none;
            }
            
            .modal-header h2 {
                font-size: 20px;
            }
        }

        @media (min-width: 992px) {
            header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                text-align: left;
            }

            .welcome-message {
                width: auto;
                margin-bottom: 0;
            }

            .welcome-message h1 {
                justify-content: flex-start;
            }
        }

        /* Mobile Cards View */
        @media (max-width: 768px) {
            .mobile-card {
                display: block;
                background: white;
                border-radius: var(--border-radius);
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: var(--box-shadow);
                border-left: 4px solid var(--primary);
            }
            
            .mobile-card.pending {
                border-left-color: var(--warning);
            }
            
            .mobile-card.in-progress {
                border-left-color: var(--info);
            }
            
            .mobile-card.resolved {
                border-left-color: var(--success);
            }
            
            .mobile-card-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            
            .mobile-card-title {
                font-weight: 600;
                color: var(--dark);
            }
            
            .mobile-card-id {
                color: var(--primary);
                font-size: 14px;
            }
            
            .mobile-card-details {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .mobile-card-detail {
                font-size: 14px;
            }

            .mobile-card-detail .priority-high,
            .mobile-card-detail .priority-medium,
            .mobile-card-detail .priority-low {
                font-weight: 600;
            }
            
            .mobile-card-actions {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            #ticket-table {
                display: none;
            }
            
            #mobile-cards {
                display: block;
            }
        }
        
        @media (min-width: 769px) {
            #ticket-table {
                display: table;
            }
            
            #mobile-cards {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-container" id="statsContainer">
            <!-- Will be filled by Django -->
        </div>

        <div class="search-container">
            <div class="search-filter-row">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search by ID, title or keyword...">
                    <button id="searchBtn"><i class="fas fa-search"></i> <span>Search</span></button>
                </div>
                <div class="filter-container">
                    <select id="priorityFilter">
                        <option value="all">All Priorities</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="statusFilter">
                        <option value="all">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- SLA Alerts for Support Engineer -->
        <div class="tickets-container visible" id="slaAlertsContainer">
            <div class="card-header">
                <h2>SLA Alerts</h2>
                <i class="fas fa-bell"></i>
            </div>
            {% if sla_alerts %}
            <div class="alerts-list">
                {% for alert in sla_alerts %}
                <a href="{% url 'ticket_detail' alert.ticket_pk %}" class="sla-alert-item {% if alert.critical %}critical{% endif %}">
                    <div class="icon"><i class="fas fa-triangle-exclamation"></i></div>
                    <div class="content">
                        <div class="title">{{ alert.title }}</div>
                        <div class="desc">{{ alert.description }}</div>
                    </div>
                    <div class="cta">View →</div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">No SLA alerts at the moment.</p>
            {% endif %}
        </div>

        <div class="tickets-container visible" id="ticketsContainer">
            <div class="card-header">
                <h2>Assigned Tickets</h2>
                <i class="fas fa-tasks"></i>
            </div>
            <div class="ticket-table-wrapper">
                <table class="ticket-table" id="ticket-table">
                    <thead>
                        <tr>
                            <th>Ticket ID</th>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Reporter</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Attachment</th>
                            <th>Time to SLA</th>
                            <th>Last Updated</th>
                            <th>Update Status</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        {% for ticket in tickets %}
                        <tr class="clickable-row" data-href="{% url 'ticket_detail' ticket.pk %}" data-ticket-id="{{ ticket.pk }}" data-priority="{{ ticket.priority|lower }}" data-status="{{ ticket.status|lower }}">
                            <td>{{ ticket.ticket_id }}</td>
                            <td>{{ ticket.title }}</td>
                            <td class="desc-cell">{{ ticket.description|default:""|truncatechars:80 }}</td>
                            <td>{{ ticket.created_by.username }}</td>
                            <td>{{ ticket.assigned_at|date:"M d, Y" }}</td>
                            <td>{{ ticket.sla_due_at|date:"M d, Y" }}</td>
                            <td class="priority-{{ ticket.priority|lower }}">{{ ticket.priority }}</td>
                            <td>
                                <span class="status-badge status-{{ ticket.status|lower }}">{{ ticket.status }}</span>
                            </td>
                            <td>
                                {% with att=ticket.attachments.all.0 %}
                                    {% if att %}
                                        {% with u=att.file.url|lower %}
                                            {% if '.png' in u or '.jpg' in u or '.jpeg' in u or '.gif' in u or '.webp' in u %}
                                                <img src="{{ att.file.url }}" alt="attachment" class="attachment-thumb">
                                            {% else %}
                                                <i class="fas fa-paperclip"></i>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                {% if ticket.sla_due_at %}
                                    <span class="sla-badge {{ ticket.sla_state|default:'future' }}">{{ ticket.sla_remaining_display|default:'—' }}</span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>{{ ticket.updated_at|date:"M d, Y" }}</td>
                            <td>
                                <select class="status-select" data-ticket-id="{{ ticket.pk }}">
                                    <option value="NEW" {% if ticket.status == 'NEW' %}selected{% endif %}>Pending</option>
                                    <option value="IN_PROGRESS" {% if ticket.status == 'IN_PROGRESS' %}selected{% endif %}>In Progress</option>
                                    <option value="RESOLVED" {% if ticket.status == 'RESOLVED' %}selected{% endif %}>Resolved</option>
                                </select>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center">No tickets assigned to you yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile Cards View -->
            <div id="mobile-cards">
                {% for ticket in tickets %}
                <div class="mobile-card {{ ticket.status|lower }}">
                    <div class="mobile-card-header">
                        <span class="mobile-card-title">{{ ticket.title }}</span>
                        <span class="mobile-card-id">#{{ ticket.ticket_id }}</span>
                    </div>
                    <div class="mobile-card-details">
                        <div class="mobile-card-detail">
                            <strong>Reporter:</strong> {{ ticket.created_by.username }}
                        </div>
                        <div class="mobile-card-detail">
                            <strong>Priority:</strong> <span class="priority-{{ ticket.priority|lower }}">{{ ticket.priority }}</span>
                        </div>
                        <div class="mobile-card-detail">
                            <strong>Status:</strong> <span class="status-badge status-{{ ticket.status|lower }}">{{ ticket.status }}</span>
                        </div>
                        <div class="mobile-card-detail">
                            <strong>Updated:</strong> {{ ticket.updated_at|date:"M d, Y" }}
                        </div>
                    </div>
                    <div class="mobile-card-actions">
                        <a href="{% url 'ticket_detail' ticket.pk %}" class="action-btn">View</a>
                        <a href="{% url 'ticket_update' ticket.pk %}" class="action-btn resolve">Resolve</a>
                        <a href="{% url 'add_comment' ticket.pk %}" class="action-btn comment">Comment</a>
                    </div>
                </div>
                {% empty %}
                <div class="no-tickets-message">No tickets assigned to you yet.</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal" id="statusModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Update Ticket Status</h2>
                <span class="close-btn">&times;</span>
            </div>
            <form id="statusForm">
                <input type="hidden" id="ticketId">
                <div class="form-group">
                    <label for="statusSelect">New Status</label>
                    <select id="statusSelect" class="form-control">
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="RESOLVED">Resolved</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn">Update Status</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to update stats cards
            function updateStats() {
                // This will be populated by Django template variables
                // Example:
                // const allCount = {{ all_tickets_count }};
                // const pendingCount = {{ pending_tickets_count }};
                // const inProgressCount = {{ in_progress_tickets_count }};
                // const resolvedCount = {{ resolved_tickets_count }};

                document.getElementById('statsContainer').innerHTML = `
                    <div class="stat-card all-tickets" data-filter="all">
                        <div class="stat-info">
                            <h3>All Tickets</h3>
                            <p>${allCount}</p>
                        </div>
                    </div>
                    <div class="stat-card pending-tickets" data-filter="Pending">
                        <div class="stat-info">
                            <h3>Pending Tickets</h3>
                            <p>${pendingCount}</p>
                        </div>
                    </div>
                    <div class="stat-card in-progress-tickets" data-filter="In Progress">
                        <div class="stat-info">
                            <h3>In Progress</h3>
                            <p>${inProgressCount}</p>
                        </div>
                    </div>
                    <div class="stat-card resolved-tickets" data-filter="Resolved">
                        <div class="stat-info">
                            <h3>Resolved</h3>
                            <p>${resolvedCount}</p>
                        </div>
                    </div>
                `;

                // Add click event to stats cards
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const filter = this.getAttribute('data-filter');
                        document.getElementById('statusFilter').value = filter;
                        filterTickets();
                    });
                });
            }

            // Filter tickets based on search and filters
            function filterTickets() {
                const q = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();
                const statusSel = document.getElementById('statusFilter')?.value || 'all';
                const prSel = (document.getElementById('priorityFilter')?.value || 'all').toLowerCase();

                document.querySelectorAll('#table-body tr').forEach(row => {
                    const idText = row.children[0]?.textContent.toLowerCase();
                    const titleText = row.children[1]?.textContent.toLowerCase();
                    const descText = row.querySelector('.desc-cell')?.textContent.toLowerCase() || '';
                    const prText = row.dataset.priority || row.querySelector('[class^="priority-"]')?.textContent.toLowerCase();
                    const statusText = row.dataset.status || row.querySelector('.status-badge')?.textContent.toLowerCase();

                    let matchSearch = true;
                    if(q) matchSearch = (idText?.includes(q) || titleText?.includes(q) || descText?.includes(q));

                    let matchStatus = true;
                    if(statusSel !== 'all') matchStatus = statusText?.includes(statusSel.toLowerCase());

                    let matchPriority = true;
                    if(prSel !== 'all') matchPriority = prText === prSel;

                    row.style.display = (matchSearch && matchStatus && matchPriority) ? '' : 'none';
                });
            }

            // Status update modal
            function openStatusModal(ticketId) {
                document.getElementById('ticketId').value = ticketId;
                // In a real implementation, you would fetch the current status from the DOM or make an AJAX call
                document.getElementById('statusModal').style.display = 'flex';
            }

            // Close modal
            function closeModal() {
                document.getElementById('statusModal').style.display = 'none';
            }

            // CSRF helper
            function getCookie(name){
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if(parts.length === 2) return parts.pop().split(';').shift();
                return '';
            }

            function humanizeStatus(s){
                const map = { 'IN_PROGRESS':'In Progress', 'RESOLVED':'Resolved', 'CLOSED':'Closed', 'NEW':'Open' };
                return map[s] || s;
            }

            function setStatusOptions(current){
                const sel = document.getElementById('statusSelect');
                sel.innerHTML = '';
                const addOpt = (val, text, selected=false) => {
                    const o = document.createElement('option');
                    o.value = val; o.textContent = text; if(selected) o.selected = true; sel.appendChild(o);
                };
                if(current === 'RESOLVED'){
                    addOpt('RESOLVED','Resolved', true);
                    addOpt('IN_PROGRESS','In Progress');
                } else { // default IN_PROGRESS
                    addOpt('IN_PROGRESS','In Progress', true);
                    addOpt('RESOLVED','Resolved');
                }
            }

            // Update ticket status via API
            function updateTicketStatus(ticketId, newStatus) {
                return fetch(`/api/tickets/${ticketId}/`, {
                    method: 'PATCH',
                    headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ status: newStatus })
                }).then(r=>{
                    return r.json().then(data => ({ ok: r.ok, data }));
                }).then(data=>{
                    if(!data.ok){
                        const msg = (data.data && data.data.detail) ? data.data.detail : 'Failed to update ticket status';
                        alert(msg);
                        return false;
                    }
                    const row = document.querySelector(`#table-body tr[data-ticket-id="${ticketId}"]`);
                    if(row){
                        const badge = row.querySelector('td:nth-child(8) .status-badge');
                        if(badge){
                            badge.textContent = humanizeStatus(newStatus);
                            badge.className = `status-badge status-${newStatus.toLowerCase()}`;
                        }
                    }
                    showToast(`Ticket ${ticketId} updated to ${humanizeStatus(newStatus)}`);
                    return true;
                }).catch(()=>{
                    alert('Failed to update ticket status');
                    return false;
                });
            }
            
            // Show toast notification
            function showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.textContent = message;
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.right = '20px';
                toast.style.backgroundColor = 'var(--primary)';
                toast.style.color = 'white';
                toast.style.padding = '12px 24px';
                toast.style.borderRadius = 'var(--border-radius)';
                toast.style.boxShadow = 'var(--box-shadow)';
                toast.style.zIndex = '1000';
                toast.style.animation = 'slideIn 0.3s, fadeOut 0.5s 2.5s forwards';
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // Event listeners
            document.getElementById('searchInput').addEventListener('input', filterTickets);
            document.getElementById('searchBtn').addEventListener('click', filterTickets);
            document.getElementById('priorityFilter').addEventListener('change', function(){filterTickets(); styleSelect(this);});
            document.getElementById('statusFilter').addEventListener('change', function(){filterTickets(); styleSelect(this);});
            document.querySelector('.close-btn').addEventListener('click', closeModal);

            function styleSelect(sel){
                sel.classList.remove('select-red','select-amber','select-green','select-blue','select-colored');
                const v = sel.value.toLowerCase();
                if(sel.id === 'priorityFilter'){
                    if(v === 'high') sel.classList.add('select-red','select-colored');
                    else if(v === 'medium') sel.classList.add('select-amber','select-colored');
                    else if(v === 'low') sel.classList.add('select-green','select-colored');
                } else if(sel.id === 'statusFilter'){
                    if(v === 'pending') sel.classList.add('select-amber','select-colored');
                    else if(v === 'in progress') sel.classList.add('select-blue','select-colored');
                    else if(v === 'resolved') sel.classList.add('select-green','select-colored');
                }
            }
            styleSelect(document.getElementById('priorityFilter'));
            styleSelect(document.getElementById('statusFilter'));

            // Image lightbox
            const lb=document.createElement('div');
            lb.className='image-lightbox';
            lb.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:9999';
            lb.innerHTML='<span class="close" style="position:absolute;top:16px;right:20px;color:#fff;font-size:28px;cursor:pointer">×</span><img style="max-width:90vw;max-height:85vh;border-radius:8px;box-shadow:0 12px 24px rgba(0,0,0,0.35)" src="" alt="">';
            document.body.appendChild(lb);
            const lbImg=lb.querySelector('img');
            const lbClose=lb.querySelector('.close');
            document.querySelectorAll('.attachment-thumb').forEach(img=>{ img.addEventListener('click',(e)=>{ e.stopPropagation(); lbImg.src=img.src; lb.style.display='flex'; }); });
            lbClose.addEventListener('click',()=>{ lb.style.display='none'; lbImg.src=''; });
            lb.addEventListener('click',(e)=>{ if(e.target===lb){ lb.style.display='none'; lbImg.src=''; } });

            // Hook up Update buttons
            // Inline select change handler for Update Status column
            document.querySelectorAll('.status-select').forEach(sel => {
                sel.dataset.prevStatus = sel.value;
                sel.addEventListener('change', function(){
                    const id = this.getAttribute('data-ticket-id');
                    const newStatus = this.value;
                    const prev = this.dataset.prevStatus;
                    updateTicketStatus(id, newStatus).then(success => {
                        if(success){
                            this.dataset.prevStatus = newStatus;
                            // apply color class
                            this.classList.remove('pending','in-progress','resolved');
                            if(newStatus === 'NEW') this.classList.add('pending');
                            else if(newStatus === 'IN_PROGRESS') this.classList.add('in-progress');
                            else if(newStatus === 'RESOLVED') this.classList.add('resolved');
                        } else {
                            this.value = prev;
                        }
                    });
                });
            });

            // Initial color classes for status selects
            document.querySelectorAll('.status-select').forEach(sel => {
                const v = sel.value;
                sel.classList.remove('pending','in-progress','resolved');
                if(v === 'NEW') sel.classList.add('pending');
                else if(v === 'IN_PROGRESS') sel.classList.add('in-progress');
                else if(v === 'RESOLVED') sel.classList.add('resolved');
            });

            // Clickable rows to open ticket detail (ignore clicks on controls)
            document.querySelectorAll('.clickable-row').forEach(row => {
                row.addEventListener('click', function(e){
                    const tag = e.target.tagName.toLowerCase();
                    if(tag === 'select' || tag === 'option' || e.target.closest('a')) return;
                    const href = this.getAttribute('data-href');
                    if(href) window.location.href = href;
                });
            });
            
            document.getElementById('statusForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const ticketId = document.getElementById('ticketId').value;
                const newStatus = document.getElementById('statusSelect').value;
                updateTicketStatus(ticketId, newStatus);
                closeModal();
            });

            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('statusModal')) {
                    closeModal();
                }
            });

            // Initialize
            updateStats();
            
            // Add CSS for toast animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
{% endblock %}
